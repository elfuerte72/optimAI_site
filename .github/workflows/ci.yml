name: CI

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÑ‚Ð¾Ñ‚ workflow Ð½Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ push, pull_request Ð² Ð²ÐµÑ‚ÐºÐ¸ dev Ð¸ main
on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev]

jobs:
  # Ð”Ð¶Ð¾Ð± Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸ ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache node_modules
        id: cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci

  # Ð”Ð¶Ð¾Ð± Ð´Ð»Ñ Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð° Ñ Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ñ‚Ð¾Ð»ÐµÑ€Ð°Ð½Ñ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ Ðº Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÑÐ¼
  lint-zero:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        run: npm ci --prefer-offline

      - name: Lint code with zero warnings tolerance
        run: npm run lint -- --max-warnings 0

  # Ð”Ð¶Ð¾Ð± Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼
  test:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        run: npm ci --prefer-offline

      - name: Run tests with coverage
        run: npm test -- --coverage --watchAll=false --coverageReporters=lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

  # Ð”Ð¶Ð¾Ð± Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
  build:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        run: npm ci --prefer-offline

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

      - name: Build project
        run: npm run build

  # Ð”Ð¶Ð¾Ð± Ð´Ð»Ñ Ð°ÑƒÐ´Ð¸Ñ‚Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
  audit:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        run: npm ci --prefer-offline

      - name: Audit npm dependencies (fail on high/critical)
        run: npm audit --audit-level=high

  # Ð”Ð¶Ð¾Ð± Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÐ²Ð¾Ð´ÐºÐ¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
  coverage:
    runs-on: ubuntu-latest
    needs: [lint-zero, test, build, audit]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Job Summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint (Zero Warnings) | ${{ needs.lint-zero.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ESLint warnings: ${{ needs.lint-zero.result == 'success' && '0' || '>0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Coverage report uploaded to Codecov |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Next.js build with incremental cache |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security Audit | ${{ needs.audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | No high/critical vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY